# winh

## Goal

- Windows11 で動く
    - written in Rust
    - this can be compiled on any platform (e.g. WSL)
    - 単一の exe ファイルが生成される (without installer)
- 単一画面を持つGUI
- スタートボタンが大きくある
    - 押すとボタンは停止ボタンに変わる
    - Windows規定の音声入力から音声入力を受け付ける
    - 2秒間音声入力がなければ停止
        - そこまでの音声入力を mp3 で一時的に保存
        - openai/gpt-4o-transcribe に投げる
        - テキストが返ってくる
            - テキストをGUIに表示
            - さらに、クリップボードにコピー
- 簡易設定
    - 設定画面をモーダルで開く
        - 無音検出の秒数設定 (デフォルト2秒)
        - OpenAI API Key の設定
        - openai model の設定 (デフォルト gpt-4o-transcribe)
    - 以上の設定はローカルに保存

## TODO

### Phase 1: 基本セットアップ ✅ 完了
- [x] GUIフレームワークの選定と導入（egui 0.29を採用）
- [x] 基本的なウィンドウとスタート/停止ボタンのUI実装
- [x] ボタン状態の切り替え機能（⏺ Start / ⏹ Stop）
- [x] Makefileの作成とクロスコンパイル設定
- [x] mingw-w64依存関係の設定
- [x] README.mdの作成

### Phase 2: 音声入力機能 ✅ 完了
- [x] Windows音声入力APIの調査と選定（cpal 0.15を採用）
- [x] 音声入力のキャプチャ機能実装（AudioRecorderモジュール）
- [x] 音声データのバッファリング（Arc<Mutex<Vec<f32>>>で実装）
- [x] GUIとの統合（リアルタイム録音情報表示）

### Phase 3: 音声処理 ✅ 完了
- [x] 無音検出ロジックの実装（振幅しきい値ベース、デフォルト0.01）
- [x] 音声データをWAV形式で一時保存する機能（houndクレート使用）
- [x] 一時ファイルの管理（tempfileクレート使用、自動命名）
- [x] 自動無音検出による録音停止機能（デフォルト2秒）
- [x] リアルタイム無音時間表示

### Phase 4: OpenAI API連携 ✅ 完了
- [x] HTTP clientの導入（reqwest 0.12、blocking + multipart機能）
- [x] OpenAI Whisper API への音声ファイル送信機能（multipart/form-data）
- [x] API レスポンスのパース処理（serde_json使用）
- [x] エラーハンドリング（ネットワークエラー、APIエラー、ファイルエラー、パースエラー）
- [x] バックグラウンドスレッドでの文字起こし処理
- [x] GUIへの文字起こし結果表示
- [x] 環境変数OPENAI_API_KEYからAPIキー読み込み

### Phase 5: 結果表示とクリップボード ✅ 完了
- [x] 文字起こし結果をGUIに表示（Phase 4で実装済み）
- [x] クリップボードへのテキストコピー機能（arboard 3.3使用）
- [x] コピー成功・失敗のステータス表示

### Phase 6: 設定機能 ✅ 完了
- [x] 設定データ構造の定義（無音検出秒数、API Key、モデル名、無音しきい値）
- [x] 設定画面のモーダルUI実装（⚙ Settingsボタン）
- [x] 設定の読み込み・保存機能（JSON形式）
- [x] 設定ファイルの保存先決定（dirs crateでクロスプラットフォーム対応）
- [x] コマンドライン引数でのAPI Key指定（OPENAI_API_KEY=...）
- [x] 設定のリアルタイム適用
- [x] モデルのデフォルトは gpt-4o-transcribe に

### Phase 6.5 ✅ 完了

- [x] src/audio.rs
    - 録音開始すぐは無音検出しないように修正 (3sec 余裕を持たせる)
    - save_audio_to_wav では **先頭から** 無音部分を削除 (trim)
        - 0.2秒程度だけ無音を残す

### Phase 7: 仕上げ
- [ ] エラー表示UI（API key未設定、ネットワークエラー等）
- [ ] リリースビルドの動作確認
- [ ] Windows11での実機テスト
- [ ] ドキュメント整備（README更新、使用方法記載）
- [ ] .github/workflows
    - Rust のCI設定
    - Windows向けバイナリリリースの自動化
- [ ] コードのリファクタリング
    - rustfmt
    - Warning の解消

## 進捗状況

- **Phase 1**: ✅ 完了 (2025-12-17)
  - GUI基盤の構築完了
  - Windows向けビルド環境構築完了
  - 生成物: `winh.exe` (基本UI実装済み)

- **Phase 2**: ✅ 完了 (2025-12-17)
  - cpalを使った音声入力機能実装完了
  - リアルタイム録音＆バッファリング機能
  - 録音時間・サンプル数の表示機能
  - 生成物: `winh.exe` (音声入力機能実装済み)

- **Phase 3**: ✅ 完了 (2025-12-17)
  - 無音検出ロジックの実装完了
  - 自動停止機能（2秒無音で停止）
  - WAV形式での音声保存機能
  - 一時ファイル管理システム
  - 生成物: `winh.exe` (自動録音停止＆保存機能実装済み)

- **Phase 4**: ✅ 完了 (2025-12-17)
  - OpenAI Whisper API連携完了
  - バックグラウンドスレッドでの文字起こし
  - APIエラーハンドリング
  - 文字起こし結果のGUI表示
  - 生成物: `winh.exe` (完全な音声文字起こし機能実装済み)

- **Phase 5**: ✅ 完了 (2025-12-17)
  - 文字起こし結果のGUI表示完了
  - クリップボードへの自動コピー機能
  - エラーハンドリング付きコピー処理
  - 生成物: `winh.exe` (クリップボード機能実装済み)

- **Phase 6**: ✅ 完了 (2025-12-17)
  - 設定機能完了（設定画面UI）
  - JSON形式での設定保存/読み込み
  - コマンドライン引数でのAPI Key指定
  - クロスプラットフォーム対応の設定ファイル保存先
  - 生成物: `winh.exe` (設定機能実装済み)

- **Phase 6.5**: ✅ 完了 (2025-12-17)
  - 録音開始直後の無音検出を防ぐ3秒間の猶予期間を追加
  - 先頭の無音部分を削除する機能を実装（0.2秒のみ保持）
  - API送信前のオーディオファイルサイズ削減と品質向上
  - 生成物: `winh.exe` (改善された音声処理機能)

- **Phase 7**: 一部完了、残りは仕上げフェーズへ
  - 次のステップ: ドキュメント整備、CI/CD設定

## @CLAUDE

- このファイルは適宜読み直してチェックして
- あなたも、このファイルを編集できる
- Phase完了時は進捗状況セクションを更新すること
